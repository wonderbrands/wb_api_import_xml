import time

from flask import Flask, render_template, request, make_response, url_for, session
import json
import jsonrpc
import jsonrpclib
import random
import urllib.request
import getpass
import http
import requests
from pprint import pprint
import logging
import zipfile
import socket
import os
import locale
import xmlrpc.client
import base64
import openpyxl
import xlrd
import pandas as pd
#import MySQLdb
import mysql.connector
import smtplib
import ssl
import email
from email.message import EmailMessage
from email.utils import make_msgid
from email.mime.multipart import MIMEMultipart
from email.mime.base import MIMEBase
from email.mime.text import MIMEText

#API Configuration
dir_path = os.path.dirname(os.path.realpath(__file__))
#server_url  ='https://wonderbrands-v3-8443304.dev.odoo.com'
#db_name = 'wonderbrands-v3-8443304'
#username = 'admin'
#password = 'admin123'

#server_url  ='https://wonderbrands-v3-8917917.dev.odoo.com'
#db_name = 'wonderbrands-v3-8917917'
#username = 'admin'
#password = 'nK738*rxc#nd'

print('----------------------------------------------------------------')
print('SCRIPT DE ENVÍO DE CORREO')
print('----------------------------------------------------------------')
print('Conectando API Odoo')
#common = xmlrpc.client.ServerProxy('{}/xmlrpc/2/common'.format(server_url))
#uid = common.authenticate(db_name, username, password, {})
#models = xmlrpc.client.ServerProxy('{}/xmlrpc/2/object'.format(server_url))
#print(common)
print('Conexión con Odoo establecida')
print('----------------------------------------------------------------')
print('Obteniendo información')
print('----------------------------------------------------------------')
inv_ids = [592450, 592451, 592452, 592453, 592454, 592455, 592456, 592457, 592458, 592459, 592460, 592461, 592462, 592463, 592464, 592465, 592466, 592467, 592468, 592469, 592470, 592471, 592472, 592473, 592474, 592475, 592476, 592477, 592478, 592479, 592480, 592481, 592482, 592483, 592484, 592485, 592486, 592487, 592488, 592489, 592490, 592491, 592492, 592493, 592494, 592495, 592496, 592497, 592498, 592499, 592500, 592501, 592502, 592503, 592504, 592505, 592506, 592507, 592508, 592509, 592510, 592511, 592512, 592513, 592514, 592515, 592516, 592517, 592518, 592519, 592520, 592521, 592522, 592523, 592524, 592525, 592526, 592527, 592528, 592529, 592530, 592531, 592532, 592533, 592534, 592535, 592536, 592537, 592538, 592539, 592540, 592541, 592542, 592543, 592544, 592545, 592546, 592547, 592548, 592549, 592550, 592551, 592552, 592553, 592554, 592555, 592556, 592557, 592558, 592559, 592560, 592561, 592562, 592563, 592564, 592565, 592566, 592567, 592568, 592569, 592570, 592571, 592572, 592573, 592574, 592575, 592576, 592577, 592578, 592579, 592580, 592581, 592582, 592583, 592584, 592585, 592586, 592587, 592588, 592589, 592590, 592591, 592592, 592593, 592594, 592595, 592596, 592597, 592598, 592599, 592600, 592601, 592602, 592603, 592604, 592605, 592606, 592607, 592608, 592609, 592610, 592611, 592612, 592613, 592614, 592615, 592616, 592617, 592618, 592619, 592620, 592621, 592622, 592623, 592624, 592625, 592626, 592627, 592628, 592629, 592630, 592631, 592632, 592633, 592634, 592635, 592636, 592637, 592638, 592639, 592640, 592641, 592642, 592643, 592644, 592645, 592646, 592647, 592648, 592649, 592650, 592651, 592652, 592653, 592654, 592655, 592656, 592657, 592658, 592659, 592660, 592661, 592662, 592663, 592664, 592665, 592666, 592667, 592668, 592669, 592670, 592671, 592672, 592673, 592674, 592675, 592676, 592677, 592678, 592679, 592680, 592681, 592682, 592683, 592684, 592685, 592686, 592687, 592688, 592689, 592690, 592691, 592692, 592693, 592694, 592695, 592696, 592697, 592698, 592699, 592700, 592701, 592702, 592703, 592704, 592705, 592706, 592707, 592708, 592709, 592710, 592711, 592712, 592713, 592714, 592715, 592716, 592717, 592718, 592719, 592720, 592721, 592722, 592723, 592724, 592725, 592726, 592727, 592728, 592729, 592730, 592731, 592732, 592733, 592734, 592735, 592736, 592737, 592738, 592739, 592740, 592741, 592742, 592743, 592744, 592745, 592746, 592747, 592748, 592749, 592750, 592751, 592752, 592753, 592754, 592755, 592756, 592757, 592758, 592759, 592760, 592761, 592762, 592763, 592764, 592765, 592766, 592767, 592768, 592769, 592770, 592771, 592772, 592773, 592774, 592775, 592776, 592777, 592778, 592779, 592780, 592781, 592782, 592783, 592784, 592785, 592786, 592787, 592788, 592789, 592790, 592791, 592792, 592793, 592794, 592795, 592796, 592797, 592798, 592799, 592800, 592801, 592802, 592803, 592804, 592805, 592806, 592807, 592808, 592809, 592810, 592811, 592812, 592813, 592814, 592815, 592816, 592817, 592818, 592819, 592820, 592821, 592822, 592823, 592824, 592825, 592826, 592827, 592828, 592829, 592830, 592831, 592832, 592833, 592834, 592835, 592836, 592837, 592838, 592839, 592840, 592841, 592842, 592843, 592844, 592845, 592846, 592847, 592848, 592849, 592850, 592851, 592852, 592853, 592854, 592855, 592856, 592857, 592858, 592859, 592860, 592861, 592862, 592863, 592864, 592865, 592866, 592867, 592868, 592869, 592870, 592871, 592872, 592873, 592874, 592875, 592876, 592877, 592878, 592879, 592880, 592881, 592882, 592883, 592884, 592885, 592886, 592887, 592888, 592889, 592890, 592891, 592892, 592893, 592894, 592895, 592896, 592897, 592898, 592899, 592900, 592901, 592902, 592903, 592904, 592905, 592906, 592907, 592908, 592909, 592910, 592911, 592912, 592913, 592914, 592915, 592916, 592917, 592918, 592919, 592920, 592921, 592922, 592923, 592924, 592925, 592926, 592927, 592928, 592929, 592930, 592931, 592932, 592933, 592934, 592935, 592936, 592937, 592938, 592939, 592940, 592941, 592942, 592943, 592944, 592945, 592946, 592947, 592948, 592949, 592950, 592951, 592952, 592953, 592954, 592955, 592956, 592957, 592958, 592959, 592960, 592961, 592962, 592963, 592964, 592965, 592966, 592967, 592968, 592969, 592970, 592971, 592972, 592973, 592974, 592975, 592976, 592977, 592978, 592979, 592980, 592981, 592982, 592983, 592984, 592985, 592986, 592987, 592988, 592989, 592990, 592991, 592992, 592993, 592994, 592995, 592996, 592997, 592998, 592999, 593000, 593001, 593002, 593003, 593004, 593005, 593006, 593007, 593008, 593009, 593010, 593011, 593012, 593013, 593014, 593015, 593016, 593017, 593018, 593019, 593020, 593021, 593022, 593023, 593024, 593025, 593026, 593027, 593028, 593029, 593030, 593031, 593032, 593033, 593034, 593035, 593036, 593037, 593038, 593039, 593040, 593041, 593042, 593043, 593044, 593045, 593046, 593047, 593048, 593049, 593050, 593051, 593052, 593053, 593054, 593055, 593056, 593057, 593058, 593059, 593060, 593061, 593062, 593063, 593064, 593065, 593066, 593067, 593068, 593069, 593070, 593071, 593072, 593073, 593074, 593075, 593076, 593077, 593078, 593079, 593080, 593081, 593082, 593083, 593084, 593085, 593086, 593087, 593088, 593089, 593090, 593091, 593092, 593093, 593094, 593095, 593096, 593097, 593098, 593099, 593100, 593101, 593102, 593103, 593104, 593105, 593106, 593107, 593108, 593109, 593110, 593111, 593112, 593113, 593114, 593115, 593116, 593117, 593118, 593119, 593120, 593121, 593122, 593123, 593124, 593125, 593126, 593127, 593128, 593129, 593130, 593131, 593132, 593133, 593134, 593135, 593136, 593137, 593138, 593139, 593140, 593141, 593142, 593143, 593144, 593145, 593146, 593147, 593148, 593149, 593150, 593151, 593152, 593153, 593154, 593155, 593156, 593157, 593158, 593159, 593160, 593161, 593162, 593163, 593164, 593165, 593166, 593167, 593168, 593169, 593170, 593171, 593172, 593173, 593174, 593175, 593176, 593177, 593178, 593179, 593180, 593181, 593182, 593183, 593184, 593185, 593186, 593187, 593188, 593189, 593190, 593191, 593192, 593193, 593194, 593195, 593196, 593197, 593198, 593199, 593200, 593201, 593202, 593203, 593204, 593205, 593206, 593207, 593208, 593209, 593210, 593211, 593212, 593213, 593214, 593215, 593216, 593217, 593218, 593219, 593220, 593221, 593222, 593223, 593224, 593225, 593226, 593227, 593228, 593229, 593230, 593231, 593232, 593233, 593234, 593235, 593236, 593237, 593238, 593239, 593240, 593241, 593242, 593243, 593244, 593245, 593246, 593247, 593248, 593249, 593250, 593251, 593252, 593253, 593254, 593255, 593256, 593257, 593258, 593259, 593260, 593261, 593262, 593263, 593264, 593265, 593266, 593267, 593268, 593269, 593270, 593271, 593272, 593273, 593274, 593275, 593276, 593277, 593278, 593279, 593280, 593281, 593282, 593283, 593284, 593285, 593286, 593287, 593288, 593289, 593290, 593291, 593292, 593293, 593294, 593295, 593296, 593297, 593298, 593299, 593300, 593301, 593302, 593303, 593304, 593305, 593306, 593307, 593308, 593309, 593310, 593311, 593312, 593313, 593314, 593315, 593316, 593317, 593318, 593319, 593320, 593321, 593322, 593323, 593324, 593325, 593326, 593327, 593328, 593329, 593330, 593331, 593332, 593333, 593334, 593335, 593336, 593337, 593338, 593339, 593340, 593341, 593342, 593343, 593344, 593345, 593346, 593347, 593348, 593349, 593350, 593351, 593352, 593353, 593354, 593355, 593356, 593357, 593358, 593359, 593360, 593361, 593362, 593363, 593364, 593365, 593366, 593367, 593368, 593369, 593370, 593371, 593372, 593373, 593374, 593375, 593376, 593377, 593378, 593379, 593380, 593381, 593382, 593383, 593384, 593385, 593386, 593387, 593388, 593389, 593390, 593391, 593392, 593393, 593394, 593395, 593396, 593397, 593398, 593399, 593400, 593401, 593402, 593403, 593404, 593405, 593406, 593407, 593408, 593409, 593410, 593411, 593412, 593413, 593414, 593415, 593416, 593417, 593418, 593419, 593420, 593421, 593422, 593423, 593424, 593425, 593426, 593427, 593428, 593429, 593430, 593431, 593432, 593433, 593434, 593435, 593436, 593437, 593438, 593439, 593440, 593441, 593442, 593443, 593444, 593445, 593446, 593447, 593448, 593449, 593450, 593451, 593452, 593453, 593454, 593455, 593456, 593457, 593458, 593459, 593460, 593461, 593462, 593463, 593464, 593465, 593466, 593467, 593468, 593469, 593470, 593471, 593472, 593473, 593474, 593475, 593476, 593477, 593478, 593479, 593480, 593481, 593482, 593483, 593484, 593485, 593486, 593487, 593488, 593489, 593490, 593491, 593492, 593493, 593494, 593495, 593496, 593497, 593498, 593499, 593500, 593501, 593502, 593503, 593504, 593505, 593506, 593507, 593508, 593509, 593510, 593511, 593512, 593513, 593514, 593515, 593516, 593517, 593518, 593519, 593520, 593521, 593522, 593523, 593524, 593525, 593526, 593527, 593528, 593529, 593530, 593531, 593532, 593533, 593534, 593535, 593536, 593537, 593538, 593539, 593540, 593541, 593542, 593543, 593544, 593545, 593546, 593547, 593548, 593549, 593550, 593551, 593552, 593553, 593554, 593555, 593556, 593557, 593558, 593559, 593560, 593561, 593562, 593563, 593564, 593565, 593566, 593567, 593568, 593569, 593570, 593571, 593572, 593573, 593574, 593575, 593576, 593577, 593578, 593579, 593580, 593581, 593582, 593583, 593584, 593585, 593586, 593587, 593588, 593589, 593590, 593591, 593592, 593593, 593594, 593595, 593596, 593597, 593598, 593599, 593600, 593601, 593602, 593603, 593604, 593605, 593606, 593607, 593608, 593609, 593610, 593611, 593612, 593613, 593614, 593615, 593616, 593617, 593618, 593619, 593620, 593621, 593622, 593623, 593624, 593625, 593626, 593627, 593628, 593629, 593630, 593631, 593632, 593633, 593634, 593635, 593636, 593637, 593638, 593639, 593640, 593641, 593642, 593643, 593644, 593645, 593646, 593647, 593648, 593649, 593650, 593651, 593652, 593653, 593654, 593655, 593656, 593657, 593658, 593659, 593660, 593661, 593662, 593663, 593664, 593665, 593666, 593667, 593668, 593669, 593670, 593671, 593672, 593673, 593674, 593675, 593676, 593677, 593678, 593679, 593680, 593681, 593682, 593683, 593684, 593685, 593686, 593687, 593688, 593689, 593690, 593691, 593692, 593693, 593694, 593695, 593696, 593697, 593698, 593699, 593700, 593701, 593702, 593703, 593704, 593705, 593706, 593707, 593708, 593709, 593710, 593711, 593712, 593713, 593714, 593715, 593716, 593717, 593718, 593719, 593720, 593721, 593722, 593723, 593724, 593725, 593726, 593727, 593728, 593729, 593730, 593731, 593732, 593733, 593734, 593735, 593736, 593737, 593738, 593739, 593740, 593741, 593742, 593743, 593744, 593745, 593746, 593747, 593748, 593749, 593750, 593751, 593752, 593753, 593754, 593755, 593756, 593757, 593758, 593759, 593760, 593761, 593762, 593763, 593764, 593765, 593766, 593767, 593768, 593769, 593770, 593771, 593772, 593773, 593774, 593775, 593776, 593777, 593778, 593779, 593780, 593781, 593782, 593783, 593784, 593785, 593786, 593787, 593788, 593789, 593790, 593791, 593792, 593793, 593794, 593795, 593796, 593797, 593798, 593799, 593800, 593801, 593802, 593803, 593804, 593805, 593806, 593807, 593808, 593809, 593810, 593811, 593812, 593813, 593814, 593815, 593816, 593817, 593818, 593819, 593820, 593821, 593822, 593823, 593824, 593825, 593826, 593827, 593828, 593829, 593830, 593831, 593832, 593833, 593834, 593835, 593836, 593837, 593838, 593839, 593840, 593841, 593842, 593843, 593844, 593845, 593846, 593847, 593848, 593849, 593850, 593851, 593852, 593853, 593854, 593855, 593856, 593857, 593858, 593859, 593860, 593861, 593862, 593863, 593864, 593865, 593866, 593867, 593868, 593869, 593870, 593871, 593872, 593873, 593874, 593875, 593876, 593877, 593878, 593879, 593880, 593881, 593882, 593883, 593884, 593885, 593886, 593887, 593888, 593889, 593890, 593891, 593892, 593893, 593894, 593895, 593896, 593897, 593898, 593899, 593900, 593901, 593902, 593903, 593904, 593905, 593906, 593907, 593908, 593909, 593910, 593911, 593912, 593913, 593914, 593915, 593916, 593917, 593918, 593919, 593920, 593921, 593922, 593923, 593924, 593925, 593926, 593927, 593928, 593929, 593930, 593931, 593932, 593933, 593934, 593935, 593936, 593937, 593938, 593939, 593940, 593941, 593942, 593943, 593944, 593945, 593946, 593947, 593948, 593949, 593950, 593951, 593952, 593953, 593954, 593955, 593956, 593957, 593958, 593959, 593960, 593961, 593962, 593963, 593964, 593965, 593966, 593967, 593968, 593969, 593970, 593971, 593972, 593973, 593974, 593975, 593976, 593977, 593978, 593979, 593980, 593981, 593982, 593983, 593984, 593985, 593986, 593987, 593988, 593989, 593990, 593991, 593992, 593993, 593994, 593995, 593996, 593997, 593998, 593999, 594000, 594001, 594002, 594003, 594004, 594005, 594006, 594007, 594008, 594009, 594010, 594011, 594012, 594013, 594014, 594015, 594016, 594017, 594018, 594019, 594020, 594021, 594022, 594023, 594024, 594025, 594026, 594027, 594028, 594029, 594030, 594031, 594032, 594033, 594034, 594035, 594036, 594037, 594038, 594039, 594040, 594041, 594042, 594043, 594044, 594045, 594046, 594047, 594048, 594049, 594050, 594051, 594052, 594053, 594054, 594055, 594056, 594057, 594058, 594059, 594060, 594061, 594062, 594063, 594064, 594065, 594066, 594067, 594068, 594069, 594070, 594071, 594072, 594073, 594074, 594075, 594076, 594077, 594078, 594079, 594080, 594081, 594082, 594083, 594084, 594085, 594086, 594087, 594088, 594089, 594090, 594091, 594092, 594093, 594094, 594095, 594096, 594097, 594098, 594099, 594100, 594101, 594102, 594103, 594104, 594105, 594106, 594107, 594108, 594109, 594110, 594111, 594112, 594113, 594114, 594115, 594116, 594117, 594118, 594119, 594120, 594121, 594122, 594123, 594124, 594125, 594126, 594127, 594128, 594129, 594130, 594131, 594132, 594133, 594134, 594135, 594136, 594137, 594138, 594139, 594140, 594141, 594142, 594143, 594144, 594145, 594146, 594147, 594148, 594149, 594150, 594151, 594152, 594153, 594154, 594155, 594156, 594157, 594158, 594159, 594160, 594161, 594162, 594163, 594164, 594165, 594166, 594167, 594168, 594169, 594170, 594171, 594172, 594173, 594174, 594175, 594176, 594177, 594178, 594179, 594180, 594181, 594182, 594183, 594184, 594185, 594186, 594187, 594188, 594189, 594190, 594191, 594192, 594193, 594194, 594195, 594196, 594197, 594198, 594199, 594200, 594201, 594202, 594203, 594204, 594205, 594206, 594207, 594208, 594209, 594210, 594211, 594212, 594213, 594214, 594215, 594216, 594217, 594218, 594219, 594220, 594221, 594222, 594223, 594224, 594225, 594226, 594227, 594228, 594229, 594230, 594231, 594232, 594233, 594234, 594235, 594236, 594237, 594238, 594239, 594240, 594241, 594242, 594243, 594244, 594245, 594246, 594247, 594248, 594249, 594250, 594251, 594252, 594253, 594254, 594255, 594256, 594257, 594258, 594259, 594260, 594261, 594262, 594263, 594264, 594265, 594266, 594267, 594268, 594269, 594270, 594271, 594272, 594273, 594274, 594275, 594276, 594277, 594278, 594279, 594280, 594281, 594282, 594283, 594284, 594285, 594286, 594287, 594288, 594289, 594290, 594291, 594292, 594293, 594294, 594295, 594296, 594297, 594298, 594299, 594300, 594301, 594302, 594303, 594304, 594305, 594306, 594307, 594308, 594309, 594310, 594311, 594312, 594313, 594314, 594315, 594316, 594317, 594318, 594319, 594320, 594321, 594322, 594323, 594324, 594325, 594326, 594327, 594328, 594329, 594330, 594331, 594332, 594333, 594334, 594335, 594336, 594337, 594338, 594339, 594340, 594341, 594342, 594343, 594344, 594345, 594346, 594347, 594348, 594349, 594350, 594351, 594352, 594353, 594354, 594355, 594356, 594357, 594358, 594359, 594360, 594361, 594362, 594363, 594364, 594365, 594366, 594367, 594368, 594369, 594370, 594371, 594372, 594373, 594374, 594375, 594376, 594377, 594378, 594379, 594380, 594381, 594382, 594383, 594384, 594385, 594386, 594387, 594388, 594389, 594390, 594391, 594392, 594393, 594394, 594395, 594396, 594397, 594398, 594399, 594400, 594401, 594402, 594403, 594404, 594405, 594406, 594407, 594408, 594409, 594410, 594411, 594412, 594413, 594414, 594415, 594416, 594417, 594418, 594419, 594420, 594421, 594422, 594423, 594424, 594425, 594426, 594427, 594428, 594429, 594430, 594431, 594432, 594433, 594434, 594435, 594436, 594437, 594438, 594439, 594440, 594441, 594442, 594443, 594444, 594445, 594446, 594447, 594448, 594449, 594450, 594451, 594452, 594453, 594454, 594455, 594456, 594457, 594458, 594459, 594460, 594461, 594462, 594463, 594464, 594465, 594466, 594467, 594468, 594469, 594470, 594471, 594472, 594473, 594474, 594475, 594476, 594477, 594478, 594479, 594480, 594481, 594482, 594483, 594484, 594485, 594486, 594487, 594488, 594489, 594490, 594491, 594492, 594493, 594494, 594495, 594496, 594497, 594498, 594499, 594500, 594501, 594502, 594503, 594504, 594505, 594506, 594507, 594508, 594509, 594510, 594511, 594512, 594513, 594514, 594515, 594516, 594517, 594518, 594519, 594520, 594521, 594522, 594523, 594524, 594525, 594526, 594527, 594528, 594529, 594530, 594531, 594532, 594533, 594534, 594535, 594536, 594537, 594538, 594539, 594540, 594541, 594542, 594543, 594544, 594545, 594546, 594547]
inv_names = []
# Crear el archivo Excel y agregar los nombres de los arrays y los resultados
print('Creando archivo excel')
print('----------------------------------------------------------------')
workbook = openpyxl.Workbook()
sheet = workbook.active
print('Agregando columnas')
print('----------------------------------------------------------------')
sheet['A1'] = 'id_facturas'

for i in range(len(inv_ids)):
    sheet['A{}'.format(i+2)] = inv_ids[i]

# Guardar el archivo Excel en disco
print('Guardando archivo en disco')
print('----------------------------------------------------------------')
excel_file = 'resultados.xlsx'
workbook.save(excel_file)

with open(excel_file, 'rb') as file:
    file_data = file.read()
file_data_encoded = base64.b64encode(file_data).decode('utf-8')
#Escribe el cuerpo del correo
print('Escribiendo correo')
print('----------------------------------------------------------------')
body = '''\
<html>
  <head></head>
  <body>
    <p>Hola,</p>
    <p>Adjunto encontrarás el balance.</p>
  </body>
</html>
'''
# Crear el mensaje de correo electrónico - Destinatario
print('Definiendo Remitente y destinatario')
print('----------------------------------------------------------------')
msg = MIMEMultipart()
msg['From'] = 'anibal@wonderbrands.co'
msg['To'] = 'joss2608@gmail.com'
msg['Subject'] = 'Resultados de facturación - PRUEBAS'

# Adjuntar el cuerpo del correo
print('Adjuntando cuerpo del correo')
print('----------------------------------------------------------------')
msg.attach(MIMEText(body, 'html'))

# Adjuntar el archivo Excel al mensaje
print('Adjuntando archivo al correo')
print('----------------------------------------------------------------')
attachment = MIMEBase('application', 'octet-stream')
attachment.set_payload(file_data)
attachment.add_header('Content-Disposition', 'attachment', filename=excel_file)
msg.attach(attachment)

print('Leyendo configuraciones del servidor SMTP')
print('----------------------------------------------------------------')
# Enviar el mensaje por correo electrónico
smtp_server = 'smtp.gmail.com'
smtp_port = 587
smtp_username = 'anibal@wonderbrands.co'
smtp_password = 'iwvrlrxkiydxueer'

print('Enviando')
print('----------------------------------------------------------------')
#smtp = smtplib.SMTP(smtp_server, smtp_port)
#smtp.starttls()
#smtp.login(smtp_username, smtp_password)
#smtp.sendmail(smtp_username, msg['To'], msg.as_string())
#smtp.quit()
try:
    smtp = smtplib.SMTP(smtp_server, smtp_port)
    smtp.starttls()
    smtp.login(smtp_username, smtp_password)
    smtp.sendmail(smtp_username, msg['To'], msg.encode())
    smtp.quit()
except Exception as e:
    print(f"Error al enviar correo: {e}")
print('CORREO ENVIADO EXITOSAMENTE')
print('----------------------------------------------------------------')